<?xml version="1.0" encoding="utf-8"?>
<bento:BentoApplication xmlns:fx="http://ns.adobe.com/mxml/2009" 
			   			xmlns:s="library://ns.adobe.com/flex/spark" 
			   			xmlns:mx="library://ns.adobe.com/flex/mx"
			  			xmlns:bento="com.clarityenglish.bento.*"
						xmlns:tester="com.clarityenglish.ieltstester.view.tester.*"
						implements="com.clarityenglish.bento.view.interfaces.IBentoApplication"
						creationComplete="creationComplete(event)"
						addedToStage="addedToStage(event)">
	
	<fx:Metadata>
		[SWF(width=1200, height=800)]
	</fx:Metadata>
	
	<fx:Style source="ieltstester.css" />
	
	<fx:Script>
		<![CDATA[
			import com.clarityenglish.bento.BBNotifications;
			import com.clarityenglish.bento.BentoFacade;
			import com.clarityenglish.bento.model.BentoProxy;
			import com.clarityenglish.bento.model.ExerciseProxy;
			import com.clarityenglish.bento.vo.Href;
			import com.clarityenglish.common.vo.config.BentoError;
			
			import mx.core.FlexGlobals;
			import mx.events.FlexEvent;
			import mx.managers.BrowserManager;
			import mx.managers.IBrowserManager;
			
			import spark.events.IndexChangeEvent;

			public var browserManager:IBrowserManager;
			
			[Bindable]
			private var serverName:String;
			
			override protected function get facade():BentoFacade {
				return IELTSTesterApplicationFacade.getInstance();
			}
			
			protected function creationComplete(event:FlexEvent):void {
				// What domain are you running in?
				// Initialise the browser manager to help with capturing events that might take us away from the application
				// and also let us parse the URL
				browserManager = BrowserManager.getInstance(); 
				//browserManager.addEventListener(BrowserChangeEvent.BROWSER_URL_CHANGE, parseURL); 
				browserManager.init("", "Testing content");
				
				// Running as a debug from Flex actually uses 'URL'
				// file:///D:/ProjectBench/Software/BentoTitles/IELTSTester/bin-debug/IELTSTesterApplication.html
				// so you have to just look for part of that. Should work for DK too I think.
				if (FlexGlobals.topLevelApplication.url.toLowerCase().indexOf('claritydevelop')>=0) {
					serverName = "claritydevelop";
				} else {
					serverName = "dock.projectbench";
				}
				
				// Kick off the PureMVC framework with a STARTUP notification
				facade.sendNotification(BBNotifications.STARTUP, this);
			}
			
			protected function addedToStage(event:Event):void {
				// Select the first entry by default
				buttonBar.selectedIndex = 0;
				buttonBar.dispatchEvent(new IndexChangeEvent(IndexChangeEvent.CHANGE));
			}
			
			protected function onButtonBarChange(event:IndexChangeEvent):void {
				var href:Href = new Href(Href.XHTML, buttonBar.selectedItem.filename, buttonBar.selectedItem.currentDir);
				testerView.href = href;
			}
			
			protected function onShowAnswersClick(event:Event):void {
				facade.sendNotification(BBNotifications.ANSWERS_SHOW);
			}
			
			protected function onMarkingClick(event:MouseEvent):void {
				// Get the current exercise
				var bentoProxy:BentoProxy = facade.retrieveProxy(BentoProxy.NAME) as BentoProxy;
				facade.sendNotification(BBNotifications.MARKING_SHOW, { exercise: bentoProxy.currentExercise } );
			}
			
			public function showErrorMessage(error:BentoError):void {
				log.error("Received error {0}", error);
			}
			
			protected function onMarkingShownClick(event:MouseEvent):void {
				// Get the current exercise
				var bentoProxy:BentoProxy = facade.retrieveProxy(BentoProxy.NAME) as BentoProxy;
				var exerciseProxy:ExerciseProxy = facade.retrieveProxy(ExerciseProxy.NAME(bentoProxy.currentExercise)) as ExerciseProxy;
				exerciseProxy.getExerciseMark(); // this marks the exercise as marked
				facade.sendNotification(BBNotifications.MARKING_SHOWN, bentoProxy.currentExercise);
			}
			
			protected function onRunGC(event:MouseEvent):void {
				System.gc();
			}
			
		]]>
	</fx:Script>
	
	<bento:layout>
		<s:VerticalLayout gap="1" />
	</bento:layout>
	
	<s:HGroup width="100%">
		<s:ButtonBar id="buttonBar" requireSelection="true" change="onButtonBarChange(event)">
			<s:dataProvider>
				<s:ArrayCollection>
					<fx:Object label="Test cases" filename="menu.xml" currentDir="http://{serverName}/Content/IELTSTester-Dave" />
					<fx:Object label="Last minute" filename="menu-Academic-LastMinute.xml" currentDir="http://{serverName}/Content/RoadToIELTS2" />
				</s:ArrayCollection>
			</s:dataProvider>
		</s:ButtonBar>
		
		<s:Spacer width="100%" />
		
		<s:Button label="Run GC" click="onRunGC(event)"/>
		<s:Button label="Disable interaction" click="onMarkingShownClick(event)"/>
		<s:Button label="Marking" click="onMarkingClick(event)"/>
		<s:Button label="Show correct answers" click="onShowAnswersClick(event)"/>
	</s:HGroup>
	
	<tester:TesterView id="testerView" width="100%" height="100%" />
	
</bento:BentoApplication>